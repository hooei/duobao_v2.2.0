function qktGetData(){null!=$.getUrlParam("qktId")?(window.sessionStorage.setItem("qktId",$.getUrlParam("qktId")),window.sessionStorage.setItem("qktPlatform",$.getUrlParam("platform")),window.sessionStorage.setItem("qktNickname",decodeURIComponent($.getUrlParam("nickname"))),window.sessionStorage.setItem("qktTel",$.getUrlParam("tel")),window.sessionStorage.setItem("qktUserLogo",$.getUrlParam("userLogo")),window.sessionStorage.setItem("qktCandy",$.getUrlParam("candy")),luanmingli.qktId=$.getUrlParam("qktId"),luanmingli.qkt.platform=$.getUrlParam("platform"),luanmingli.qkt.nickname=decodeURIComponent($.getUrlParam("nickname")),luanmingli.qkt.tel=$.getUrlParam("tel"),luanmingli.qkt.userLogo=$.getUrlParam("userLogo"),luanmingli.qkt.candy=$.getUrlParam("candy")):(luanmingli.qktId=window.sessionStorage.getItem("qktId"),luanmingli.qkt.platform=window.sessionStorage.getItem("qktPlatform"),luanmingli.qkt.nickname=decodeURIComponent(window.sessionStorage.getItem("qktNickname")),luanmingli.qkt.tel=window.sessionStorage.getItem("qktTel"),luanmingli.qkt.userLogo=window.sessionStorage.getItem("qktUserLogo"),luanmingli.qkt.candy=window.sessionStorage.getItem("qktCandy"))}function qktLogin(e,t){return 0==/^[\w\?%&=\-_\u0000-\u00FF]+$/.test(e)&&0==/[^\u0000-\u00FF]/.test(e)?void $.prompt("请设置夺宝昵称",function(e){window.sessionStorage.setItem("pressNickname",e),qktLogin(encodeURIComponent(e),t)},function(){qktLogin("(",t)}):void $.ajax({type:"post",url:luanmingli.getUrl+"registe",data:{v:luanmingli.srvVersion,content:encryptByDES(JSON.stringify({phoneNum:luanmingli.qkt.tel,password:t,nickName:e,channelid:"qikuaitang",appversion:luanmingli.version,clienttype:3,userLogo:luanmingli.qkt.userLogo,openId:luanmingli.qktId,platform:3}))},async:!0,success:function(e){if(8==e.stateCode){var t,n=function(){t=prompt("请输入昵称"),t||n()};return n(),void qktLogin(t)}if(9==e.stateCode)$.alert("您注册过夺宝，前往绑定帐号",function(){$.router.load("qkt-bind.html?tel="+luanmingli.qkt.tel)});else if(0==e.stateCode){if(luanmingli.userId=e.userInfo.userId,luanmingli.userInfo=e.userInfo,window.localStorage.setItem("userId",e.userInfo.userId),window.localStorage.setItem("userInfo",JSON.stringify(e.userInfo)),window.localStorage.setItem("userKey",e.userInfo.userKey),window.localStorage.setItem("mid",CryptoJS.MD5(e.userInfo.userId).toString()),$.whichPage("qkt-register")){var a=$("#qkt-register").find(".login_psd");a.eq(0).val()&&a.eq(1).val()&&a.eq(0).val()==a.eq(1).val()&&$.alert("设置成功",function(){$.router.back()})}}else if(14==e.stateCode){var i=window.location.href.split("?")[1];$.router.load("qkt-register.html?"+i)}else 15==e.stateCode?$.alert(e.message,function(){document.write("")}):$.alert(e.message)}})}function qktRegister(){$(".qkt-tel").html(luanmingli.qkt.tel),$(".qkt-nickname").html(decodeURIComponent(window.sessionStorage.getItem("qktNickname"))),null!=window.sessionStorage.getItem("pressNickname")&&$(".qkt-nickname").html(window.sessionStorage.getItem("pressNickname"));var e=$("#qkt-register").find(".login_psd");$("#qkt-register").find(".button").click(function(){if(e.each(function(t){e.eq(t).val()||(e.eq(t).addClass("ipt-error"),$("<span class='ipt-error-text'>请设置密码</span>").insertAfter(e.eq(t)))}),e.eq(0).val()&&e.eq(1).val()&&e.eq(0).val()!=e.eq(1).val()&&(e.addClass("ipt-error"),$("<span class='ipt-error-text'>两次密码不一致</span>").insertAfter(e)),e.eq(0).val()&&e.eq(1).val()&&e.eq(0).val()==e.eq(1).val()){var t=($.getUrlParam("tel"),CryptoJS.MD5(e.eq(1).val()).toString());qktLogin(luanmingli.qkt.nickname,t)}}),e.focus(function(){e.removeClass("ipt-error"),$(".ipt-error-text").remove()})}function qktBind(){var e=$.getUrlParam("tel");$(".qkt-bind-tel").html(e),$("#qkt-bind .forget_text").click(function(){$.showIndicator(),$.router.load("forget.html")}),$("#qkt-bind").find(".button-bind").click(function(){var t=$("#qkt-bind").find(".login_psd").val();$.ajax({type:"post",url:luanmingli.getUrl+"login",data:{v:luanmingli.srvVersion,content:encryptByDES(JSON.stringify({platform:3,phoneNum:e,password:CryptoJS.MD5(t).toString(),channelid:"qikuaitang",appversion:luanmingli.version,clienttype:3,openId:luanmingli.qktId}))},async:!0,success:function(e){0==e.stateCode?(luanmingli.userId=e.userInfo.userId,luanmingli.userInfo=e.userInfo,window.localStorage.setItem("userId",e.userInfo.userId),window.localStorage.setItem("userInfo",JSON.stringify(e.userInfo)),window.localStorage.setItem("userKey",e.userInfo.userKey),window.localStorage.setItem("mid",CryptoJS.MD5(e.userInfo.userId).toString()),$.alert("绑定成功",function(){$.router.load("personal.html")})):$.alert("登录失败")}})})}function qktPay(){$("#p-pay").find(".pay-candy-box").show(),$(".candy-left").html(luanmingli.qkt.candy),$(".p-pay-button").click(function(){var e=$(".z_pay_money_left").html();if($(".p_pay_way").find("input[type=radio]:checked").hasClass("candy")&&0!=e){way=20;var t="http://www.2333db.com/pay.html";luanmingli.qkt.backUrl&&(t="http://www.2333db.com/callback/callback_empty.html");var n;$.prompt("请输入7块糖密码",function(t){n="&password="+CryptoJS.MD5(t),luanmingli.orderInfo.cost==e?candyPrePayUrl=luanmingli.getUrl+"prePay?v="+luanmingli.srvVersion+"&way="+way+"&orderId="+luanmingli.orderInfo.orderId+"&userId="+luanmingli.userId+"&secret="+luanmingli.orderInfo.secret+n:candyPrePayUrl=luanmingli.getUrl+"prePay?v="+luanmingli.srvVersion+"&way="+way+"&orderId="+luanmingli.orderInfo.orderId+"&userId="+luanmingli.userId+"&secret="+luanmingli.orderInfo.secret+"&points="+(luanmingli.orderInfo.cost-e)+n,candyPay(candyPrePayUrl)}),window.sessionStorage.setItem("paying",luanmingli.orderInfo.orderId)}})}function candyPay(e){var t=window.sessionStorage.getItem("qktCandy"),n=$(".z_pay_money_left").html();parseInt(t)<100*parseInt(n)?$.alert("糖块不足，请重新选择支付方式"):($.showIndicator(),$.ajax({type:"post",url:e,async:!0,dataType:"json",success:function(e){setTimeout(function(){$.hideIndicator(),0==e.stateCode?(window.sessionStorage.setItem("qktCandy",window.sessionStorage.getItem("qktCandy")-100*parseInt(n)),$.router.load("pay-success.html")):$.alert("支付失败，请重试")},200)}}))}function qktBackUrl(){$.whichPage("p-receipt")||$.whichPage("p-bindtel")||(null!=$.getUrlParam("backurl")?(luanmingli.qkt.backUrl=$.getUrlParam("backurl"),window.sessionStorage.setItem("backurl",$.getUrlParam("backurl"))):null!=window.sessionStorage.getItem("backurl")&&(luanmingli.qkt.backUrl=window.sessionStorage.getItem("backurl")),luanmingli.qkt.backUrl&&0==$(".qktback").length&&$('<a class="icon pull-right qktback" href='+luanmingli.qkt.backUrl+' style="font-size:.6rem;">返回7块糖</a>').appendTo($(".page header")))}function qktRefreshButton(){$.whichPage("p-receipt")||$.whichPage("p-bindtel")||luanmingli.qktId&&!luanmingli.qkt.backUrl&&0==$(".qktback").length&&$('<a class="icon icon-refresh pull-right qktback" onclick="javascript:window.location.reload(true);" style="font-size:.8rem;"></a>').appendTo($(".page header"))}$(function(){try{luanmingli.qkt={},qktGetData(),luanmingli.qktId&&qktLogin(luanmingli.qkt.nickname||"",$.getUrlParam("mmMD5")||""),$.whichPage("qkt-register")?qktRegister():$.whichPage("p-setting")?window.sessionStorage.getItem("backurl")||$("#p-setting").find(".exit").hide():$.whichPage("qkt-bind")?qktBind():$.whichPage("p-pay")&&qktPay(),qktBackUrl(),qktRefreshButton()}catch(e){}});