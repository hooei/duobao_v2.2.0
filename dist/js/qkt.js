function qktGetData(){null!=$.getUrlParam("qktId")?(window.sessionStorage.setItem("qktId",$.getUrlParam("qktId")),window.sessionStorage.setItem("qktPlatform",$.getUrlParam("platform")),window.sessionStorage.setItem("qktNickname",decodeURIComponent($.getUrlParam("nickname"))),window.sessionStorage.setItem("qktTel",$.getUrlParam("tel")),window.sessionStorage.setItem("qktUserLogo",$.getUrlParam("userLogo")),window.sessionStorage.setItem("qktCandy",$.getUrlParam("candy")),lData.qktId=$.getUrlParam("qktId"),lData.qkt.platform=$.getUrlParam("platform"),lData.qkt.nickname=decodeURIComponent($.getUrlParam("nickname")),lData.qkt.tel=$.getUrlParam("tel"),lData.qkt.userLogo=$.getUrlParam("userLogo"),lData.qkt.candy=$.getUrlParam("candy")):(lData.qktId=window.sessionStorage.getItem("qktId"),lData.qkt.platform=window.sessionStorage.getItem("qktPlatform"),lData.qkt.nickname=decodeURIComponent(window.sessionStorage.getItem("qktNickname")),lData.qkt.tel=window.sessionStorage.getItem("qktTel"),lData.qkt.userLogo=window.sessionStorage.getItem("qktUserLogo"),lData.qkt.candy=window.sessionStorage.getItem("qktCandy"))}function qktLogin(t,e){return 0==/^[\w\?%&=\-_\u0000-\u00FF]+$/.test(t)&&0==/[^\u0000-\u00FF]/.test(t)?void $.prompt("请设置夺宝昵称",function(t){window.sessionStorage.setItem("pressNickname",t),qktLogin(encodeURIComponent(t),e)},function(){qktLogin("(",e)}):void $.ajax({type:"post",url:lData.getUrl+"registe",data:{v:lData.srvVersion,content:encryptByDES(JSON.stringify({phoneNum:lData.qkt.tel,password:e,nickName:t,channelid:"qikuaitang",appversion:lData.version,clienttype:3,userLogo:lData.qkt.userLogo,openId:lData.qktId,platform:3}))},async:!0,success:function(t){if(8==t.stateCode){var e,a=function(){e=prompt("请输入昵称"),e||a()};return a(),void qktLogin(e)}if(9==t.stateCode)$.alert("您注册过夺宝，前往绑定帐号",function(){$.router.load("qkt-bind.html?tel="+lData.qkt.tel)});else if(0==t.stateCode){if(lData.userId=t.userInfo.userId,lData.userInfo=t.userInfo,window.localStorage.setItem("userId",t.userInfo.userId),window.localStorage.setItem("userInfo",JSON.stringify(t.userInfo)),window.localStorage.setItem("userKey",t.userInfo.userKey),window.localStorage.setItem("mid",CryptoJS.MD5(t.userInfo.userId).toString()),$.whichPage("qkt-register")){var r=$("#qkt-register").find(".login_psd");r.eq(0).val()&&r.eq(1).val()&&r.eq(0).val()==r.eq(1).val()&&$.alert("设置成功",function(){$.router.back()})}}else if(14==t.stateCode){var o=window.location.href.split("?")[1];$.router.load("qkt-register.html?"+o)}else 15==t.stateCode?$.alert(t.message,function(){document.write("")}):$.alert(t.message)}})}function qktRegister(){$(".qkt-tel").html(lData.qkt.tel),$(".qkt-nickname").html(decodeURIComponent(window.sessionStorage.getItem("qktNickname"))),null!=window.sessionStorage.getItem("pressNickname")&&$(".qkt-nickname").html(window.sessionStorage.getItem("pressNickname"));var t=$("#qkt-register").find(".login_psd");$("#qkt-register").find(".button").click(function(){if(t.each(function(e){t.eq(e).val()||(t.eq(e).addClass("ipt-error"),$("<span class='ipt-error-text'>请设置密码</span>").insertAfter(t.eq(e)))}),t.eq(0).val()&&t.eq(1).val()&&t.eq(0).val()!=t.eq(1).val()&&(t.addClass("ipt-error"),$("<span class='ipt-error-text'>两次密码不一致</span>").insertAfter(t)),t.eq(0).val()&&t.eq(1).val()&&t.eq(0).val()==t.eq(1).val()){var e=($.getUrlParam("tel"),CryptoJS.MD5(t.eq(1).val()).toString());qktLogin(lData.qkt.nickname,e)}}),t.focus(function(){t.removeClass("ipt-error"),$(".ipt-error-text").remove()})}function qktBind(){var t=$.getUrlParam("tel");$(".qkt-bind-tel").html(t),$("#qkt-bind .forget_text").click(function(){$.showIndicator(),$.router.load("forget.html")}),$("#qkt-bind").find(".button-bind").click(function(){var e=$("#qkt-bind").find(".login_psd").val();$.ajax({type:"post",url:lData.getUrl+"login",data:{v:lData.srvVersion,content:encryptByDES(JSON.stringify({platform:3,phoneNum:t,password:CryptoJS.MD5(e).toString(),channelid:"qikuaitang",appversion:lData.version,clienttype:3,openId:lData.qktId}))},async:!0,success:function(t){0==t.stateCode?(lData.userId=t.userInfo.userId,lData.userInfo=t.userInfo,window.localStorage.setItem("userId",t.userInfo.userId),window.localStorage.setItem("userInfo",JSON.stringify(t.userInfo)),window.localStorage.setItem("userKey",t.userInfo.userKey),window.localStorage.setItem("mid",CryptoJS.MD5(t.userInfo.userId).toString()),$.alert("绑定成功",function(){$.router.load("personal.html")})):$.alert("登录失败")}})})}function qktPay(){$("#p-pay").find(".pay-candy-box").show(),$(".candy-left").html(lData.qkt.candy),$(".p-pay-button").click(function(){var t=$(".z_pay_money_left").html();if($(".p_pay_way").find("input[type=radio]:checked").hasClass("candy")&&0!=t){way=20;var e="http://www.2333db.com/pay.html";lData.qkt.backUrl&&(e="http://www.2333db.com/callback/callback_empty.html");var a;$.prompt("请输入7块糖密码",function(e){a="&password="+CryptoJS.MD5(e),lData.orderInfo.cost==t?candyPrePayUrl=lData.getUrl+"prePay?v="+lData.srvVersion+"&way="+way+"&orderId="+lData.orderInfo.orderId+"&userId="+lData.userId+"&secret="+lData.orderInfo.secret+a:candyPrePayUrl=lData.getUrl+"prePay?v="+lData.srvVersion+"&way="+way+"&orderId="+lData.orderInfo.orderId+"&userId="+lData.userId+"&secret="+lData.orderInfo.secret+"&points="+(lData.orderInfo.cost-t)+a,candyPay(candyPrePayUrl)}),window.sessionStorage.setItem("paying",lData.orderInfo.orderId)}})}function candyPay(t){var e=window.sessionStorage.getItem("qktCandy"),a=$(".z_pay_money_left").html();parseInt(e)<100*parseInt(a)?$.alert("糖块不足，请重新选择支付方式"):($.showIndicator(),$.ajax({type:"post",url:t,async:!0,dataType:"json",success:function(t){setTimeout(function(){$.hideIndicator(),0==t.stateCode?(window.sessionStorage.setItem("qktCandy",window.sessionStorage.getItem("qktCandy")-100*parseInt(a)),$.router.load("pay-success.html")):$.alert("支付失败，请重试")},200)}}))}function qktBackUrl(){$.whichPage("p-receipt")||$.whichPage("p-bindtel")||(null!=$.getUrlParam("backurl")?(lData.qkt.backUrl=$.getUrlParam("backurl"),window.sessionStorage.setItem("backurl",$.getUrlParam("backurl"))):null!=window.sessionStorage.getItem("backurl")&&(lData.qkt.backUrl=window.sessionStorage.getItem("backurl")),lData.qkt.backUrl&&0==$(".qktback").length&&$('<a class="icon pull-right qktback" href='+lData.qkt.backUrl+' style="font-size:.6rem;">返回7块糖</a>').appendTo($(".page header")))}function qktRefreshButton(){$.whichPage("p-receipt")||$.whichPage("p-bindtel")||lData.qktId&&!lData.qkt.backUrl&&0==$(".qktback").length&&$('<a class="icon icon-refresh pull-right qktback" onclick="javascript:window.location.reload(true);" style="font-size:.8rem;"></a>').appendTo($(".page header"))}$(function(){try{lData.qkt={},qktGetData(),lData.qktId&&qktLogin(lData.qkt.nickname||"",$.getUrlParam("mmMD5")||""),$.whichPage("qkt-register")?qktRegister():$.whichPage("p-setting")?window.sessionStorage.getItem("backurl")||$("#p-setting").find(".exit").hide():$.whichPage("qkt-bind")?qktBind():$.whichPage("p-pay")&&qktPay(),qktBackUrl(),qktRefreshButton()}catch(t){}});