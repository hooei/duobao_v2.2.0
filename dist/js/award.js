function awardGetData(){var e=$.parseJSON(window.sessionStorage.getItem("prizeInfo"));awardStatus(e)}function awardStatus(e){var a=$.parseJSON(window.sessionStorage.getItem("prizeAddress")),t=e.hasdone;$(".j-address-button").find(".button").remove(),$(".a-address-text").find("*").remove(),$(".status-info-list").find(".active").removeClass("active"),$(".j-confirm-box").find(".button").remove(),$(".a-award-shiping").html(""),$(".j-confirm-box").html(""),awardFillData(e),0==t?($(".status-info-list").find(".item-content").eq(1).addClass("active"),$(".j-address-button").html(""),awardAddressButton(a)):3==t?($(".status-info-list").find(".item-content").eq(3).addClass("active"),awardAddFillData(a,e),awardShipFillData(e),awardConfirmGet()):1==t?(awardAddFillData(a,e),awardShipFillData(e),$(".j-confirm-box").html(e.commiteTime),$(".status-info-list").find(".item-content").eq(4).addClass("active")):2==t&&($(".status-info-list").find(".item-content").eq(2).addClass("active"),$(".a-award-shiping").html("请等待……"),awardAddFillData(a,e))}function awardFillData(e){$(".a-award-time").html(e.lotteryTime),$("#p-award").find(".module2").length>0&&$("#p-award").find(".module2").remove(),$("#p-award").find(".module-first").after('<div class="module2 card z_my_prize_model"><div class="card-content"><div class="list-block media-list"><ul><li><div class="item-content"><div class="item-inner"><div class="item-title label">商品信息</div></div></div></li><li class="item-content clearfix"><div class="item-media prize_image" style="background-image:url('+e.icon+');"></div><div class="item-inner clearfix"><div class="item-title-row"><div class="item-title z_prize_title">'+e.description+'</div></div><div class="item-subtitle z_prize_content"><p>期号：'+e.phaseNumber+"</p><p>总需："+e.totalCount+"人次</p><p>幸运号码："+e.luckyCode+"</p><p>本期参与："+e.buyCount+"人次</p><p>揭晓时间："+e.lotteryTime+"</p></div></div></li></ul></div></div></div>")}function awardAddFillData(e,a){$(".j-address-button").html(a.addressTime),$("#p-award").find(".module3").length>0&&$("#p-award").find(".module3").remove(),$("#p-award").find(".module-first").after('<div class="module3 module1"><div class="list-title">地址信息</div><div class="list-block"><ul class="status-info-list"><li class="item-content"><div class="item-inner"><div class="item-title"><span>'+a.name+'</span><span class="pull-right" style="padding-right:.65rem;">'+a.telephone+'</span><p style="white-space:normal;">'+a.address+"</p></div></div></li></ul></div></div>")}function awardShipFillData(e){$(".a-award-shiping").html(e.expressTime),$("#p-award").find(".module4").length>0&&$("#p-award").find(".module4").remove(),$("#p-award").find(".module-first").after('<div class="module4 module1"><div class="list-title">物流信息</div><div class="list-block"><ul class="status-info-list"><li class="item-content"><div class="item-inner"><div class="item-title"><p>物流公司：'+e.expressComputer+"</p><p>运单号码："+e.chargeId+"</p></div></div></li></ul></div></div>")}function awardAddressButton(e){if($(".j-address-button").find(".button").remove(),$(".a-address-text").find("*").remove(),0==e.length)$(".j-address-button").append("<div onclick=\"awardEditAdd('','','','',2);\" class=\"insert button\">新增地址</div>");else{$(".j-address-button").append('<div onclick="awardChoose();" class="choose button">确认</div><div onclick="awardOther();" class="other button">使用其他</div>');var a=0;$.each(e,function(e,t){1==t.isDefault?awardAddressFill(t):a+=1}),a==e.length&&awardAddressFill(e[0])}}function awardAddressFill(e){$(".a-address-text").find("*").remove(),luanmingli.awardAddId=e.id,$(".a-address-text").append("<span>"+e.name+'</span><span style="position:absolute;right:.5rem;top:.25rem;">'+e.telephone+"</span><div>"+awardChoseAddPlus(e)+"</div>")}function awardChoseAddPlus(e){return e.address1?e.address4?e.address1+e.address2+e.address3+e.address4+e.address:e.address1+e.address2+e.address3+e.address:e.address}function awardChoose(){$.confirm("确认提交收货地址吗？",function(){var e=$.parseJSON(window.sessionStorage.getItem("prizeInfo")).treasureId;$.ajax({type:"post",url:luanmingli.getUrl+"changePrizeStatus",data:{v:luanmingli.srvVersion,content:encryptByDES(JSON.stringify({userKey:window.localStorage.getItem("userKey"),treasureId:e,status:2,addressId:luanmingli.awardAddId}))},async:!0,dataType:"json",success:function(e){var a=e.prize,t=$.parseJSON(window.sessionStorage.getItem("prizeInfo"));0==a.treasureId&&(a.treasureId=t.treasureId),0==a.totalCount&&(a.totalCount=t.totalCount),0==a.phaseNumber&&(a.phaseNumber=t.phaseNumber),a.icon||(a.icon=t.icon),$.showIndicator(),window.sessionStorage.setItem("prizeInfo",JSON.stringify(a)),window.sessionStorage.setItem("prizeForceRefresh",1),setTimeout(function(){awardStatus(a),$.hideIndicator()},500)}})})}function awardOther(e){if($.closeModal(".receipt-popup"),2!=e){$.popup('<div class="popup award-popup"><header class="bar bar-nav c_header"><a onclick="awardOtherCancel();" class="icon pull-left">取消</a><h1 class="title">选择地址</h1><a onclick="awardEditAdd();" class="j-receipt-insert pull-right">添加地址</a></header><div class="list-block"><ul class="award-popup-list" style="margin-top:2.2rem;"></ul></div></div>');var a=$.parseJSON(window.sessionStorage.getItem("prizeAddress"));$.each(a,function(e,a){$(".award-popup-list").append('<li class="item-content">'+function(e){return e==luanmingli.awardAddId?'<div class="item-media"><i class="icon icon-check" style="color:#da3651;font-size:1rem;font-weight:bold;"></i></div>':""}(a.id)+'<div onclick="awardAddressChose('+e+');" class="item-inner"><div class="item-title"><span>'+a.name+'</span><span style="margin-left:1rem;">'+a.telephone+'</span><p style="margin:0;">'+awardChoseAddPlus(a)+'</p></div><div onclick="awardEditAdd('+a.id+",'"+a.name+"',"+a.telephone+",'"+a.address+"',1,"+a.code1+","+a.code2+","+a.code3+","+a.code4+",'"+a.address1+"','"+a.address2+"','"+a.address3+"','"+a.address4+'\');" class="item-after"><i class="icon icon-edit d5"></i></div></div></li>')})}}function awardOtherCancel(){$.closeModal(".award-popup");var e=$.parseJSON(window.sessionStorage.getItem("prizeAddress"));$.each(e,function(a,t){t.id==luanmingli.awardAddId&&awardAddressFill(e[a])})}function awardAddressChose(e){$.showIndicator(),setTimeout(function(){$.closeModal(".award-popup");var a=$.parseJSON(window.sessionStorage.getItem("prizeAddress"));awardAddressFill(a[e]),$.hideIndicator()},500)}function awardEditAdd(e,a,t,i,d,s,r,n,o,l,c,p,u){event.stopPropagation();var m=e?e:"''",v=a?a:"",w=t?t:"",f=i?i:"";$.popup('<div class="popup receipt-popup"><header class="bar bar-nav c_header"><a class="icon pull-left" onclick="awardOther('+d+');">取消</a><h1 class="title">'+function(e){return e?"修改":"新增"}(e)+'收货地址</h1><a class="icon pull-right" onclick="awardAddEditSave('+m+","+d+');">保存</a></header><div class="content"><div class="list-block"><ul><li class="item-content"><input class="receipt-name" type="text" placeholder="收货人姓名" value="'+v+'" /></li><li class="item-content"><input class="receipt-tel" type="text" placeholder="手机号码" value="'+w+'" /></li><li class="item-content u-address-choose"><span>所在地区</span><input type="text" id="picker" readonly /><a class="icon icon-right"></a></li><li class="item-content"><textarea class="receipt-address" type="text" placeholder="详细地址 （街道、楼牌号等）">'+f+"</textarea></li></ul></div></div></div>",!0),s&&"null"!=s&&"undefined"!=s&&($("#picker").attr("data-lv1",s),$("#picker").attr("data-lv2",r),$("#picker").attr("data-lv3",n),o?$("#picker").attr("data-lv4",o):$("#picker").removeAttr("data-lv4")),l&&"undefined"!=l&&"null"!=l?u&&"undefined"!=u&&"null"!=u?($("#picker").val(l+c+p+u),$("#picker").val(l+c+p+u),$("#picker").attr("data-lvname1",l),$("#picker").attr("data-lvname2",c),$("#picker").attr("data-lvname3",p),$("#picker").attr("data-lvname4",u)):($("#picker").val(l+c+p),$("#picker").val(l+c+p+u),$("#picker").attr("data-lvname1",l),$("#picker").attr("data-lvname2",c),$("#picker").attr("data-lvname3",p)):($("#picker").val(""),$(".receipt-address").val("")),_getScript("js/address-picker.js",function(){addPicker()})}function awardAddEditSave(e,a){var t=$(".receipt-name"),i=$(".receipt-tel"),d=$(".receipt-address"),s=/^(0|86|17951)?1\d{10}$/.test(i.val());return t.val()?s?$("#picker").val()?d.val()?void(t.val()&&s&&d.val()&&(e?receiptUpdate(e,t.val(),i.val(),d.val()):receiptInsert(t.val(),i.val(),d.val(),a))):void $.toast("详细地址不能未空",1e3):void $.toast("请选择地址",1e3):void $.toast("请输入正确的手机号码",1e3):void $.toast("收货人姓名不能未空",1e3)}function receiptUpdate(e,a,t,i){$.ajax({type:"get",url:luanmingli.getUrl+"addressManager",data:{v:luanmingli.srvVersion,content:encryptByDES(JSON.stringify({userId:luanmingli.userId,way:3,addressId:e,address:i,telephone:t,name:a,code1:$("#picker").attr("data-lv1"),code2:$("#picker").attr("data-lv2"),code3:$("#picker").attr("data-lv3"),code4:$("#picker").attr("data-lv4")?$("#picker").attr("data-lv4"):"0",address1:$("#picker").attr("data-lvname1"),address2:$("#picker").attr("data-lvname2"),address3:$("#picker").attr("data-lvname3"),address4:$("#picker").attr("data-lvname4")?$("#picker").attr("data-lvname4"):""}))},async:!0,dataType:"json",success:function(e){0==e.stateCode&&($.showIndicator(),setTimeout(function(){$.closeModal(".receipt-popup"),window.sessionStorage.setItem("prizeAddress",JSON.stringify(e.addlist)),awardOther(),$.hideIndicator()},500))}})}function receiptInsert(e,a,t,i){$.ajax({type:"get",url:luanmingli.getUrl+"addressManager",data:{v:luanmingli.srvVersion,content:encryptByDES(JSON.stringify({userId:luanmingli.userId,way:2,address:t,telephone:a,name:e,code1:$("#picker").attr("data-lv1"),code2:$("#picker").attr("data-lv2"),code3:$("#picker").attr("data-lv3"),code4:$("#picker").attr("data-lv4")?$("#picker").attr("data-lv4"):"0",address1:$("#picker").attr("data-lvname1"),address2:$("#picker").attr("data-lvname2"),address3:$("#picker").attr("data-lvname3"),address4:$("#picker").attr("data-lvname4")?$("#picker").attr("data-lvname4"):""}))},async:!0,dataType:"json",success:function(e){0==e.stateCode&&($.showIndicator(),setTimeout(function(){if($.closeModal(".receipt-popup"),window.sessionStorage.setItem("prizeAddress",JSON.stringify(e.addlist)),$.hideIndicator(),2==i){var a=$.parseJSON(window.sessionStorage.getItem("prizeInfo"));return void awardStatus(a)}awardOther()},500))}})}function awardConfirmGet(){if(!($(".j-confirm-get").length>0)){$(".j-confirm-box").append('<div onclick="awardConfirmGetBtn(this);" class="button j-confirm-get">确认收货</div>');var e=$.parseJSON(window.sessionStorage.getItem("prizeInfo"));3!=e.hasdone&&$(".j-confirm-get").css("background-color","#b0b0b0")}}function awardConfirmGetBtn(e){var a=$.parseJSON(window.sessionStorage.getItem("prizeInfo"));3==a.hasdone&&$.confirm("是否确认收货？",function(){var e=$.parseJSON(window.sessionStorage.getItem("prizeInfo")).treasureId;$.ajax({type:"post",url:luanmingli.getUrl+"changePrizeStatus",data:{v:luanmingli.srvVersion,content:encryptByDES(JSON.stringify({userKey:window.localStorage.getItem("userKey"),treasureId:e,status:1}))},async:!0,dataType:"json",success:function(e){var a=e.prize,t=$.parseJSON(window.sessionStorage.getItem("prizeInfo"));0==a.treasureId&&(a.treasureId=t.treasureId),0==a.totalCount&&(a.totalCount=t.totalCount),0==a.phaseNumber&&(a.phaseNumber=t.phaseNumber),a.icon||(a.icon=t.icon),$.showIndicator(),window.sessionStorage.setItem("prizeInfo",JSON.stringify(a)),window.sessionStorage.setItem("prizeForceRefresh",1),setTimeout(function(){awardStatus(a),$.hideIndicator()},500)}})})}function awardRefresh(){awardGetData()}$(function(){try{$(".module4").remove(),$(".module3").remove(),$(".module2").remove(),awardGetData(),dropRefresh("#p-award",awardRefresh)}catch(e){}});